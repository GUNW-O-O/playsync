// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --- Enums ---

enum Role {
  USER
  DEALER
  STORE_ADMIN
  PLATFORM_ADMIN
}

enum SessionType {
  TOURNAMENT
  SIT_AND_GO
}

enum TransactionType {
  CHARGE    // 포인트 충전
  BUY_IN    // 게임 참가비
  REBUY     // 리바인/애드온
  PRIZE     // 상금 수령
  REFUND    // 취소 환불
}

enum SessionStatus {
  PENDING   // 생성 직후, 바이인 대기
  ONGOING   // 게임 진행 중
  SYNCING   // 테이블 이동/밸런싱 대기 상태
  FINISHED  // 최종 종료 (영구 데이터 보존 상태)
}

enum ParticipationStatus {
  WAITING    // 바이인 완료 후 대기
  PLAYING    // 테이블 착석 중
  ELIMINATED // 탈락
  AWARDED    // 상금권 진입 후 종료
}

// --- Models ---

model User {
  id        String   @id @default(uuid())
  nickname  String   @unique
  password  String
  points    Int      @default(0) // 실제 가용 포인트
  role      Role     @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participations SessionParticipation[]
  tablePlayers   TablePlayer[]
  stores         Store[]
  transactions   PointTransaction[]
}

model PointTransaction {
  id        String          @id @default(uuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id])
  amount    Int             // 포인트 변동량
  type      TransactionType
  sessionId String?         // 어떤 게임 세션에서 발생했는지
  description String?       // "1번 테이블 리바인" 등 비고
  createdAt DateTime        @default(now())
}

model Store {
  id             String          @id @default(uuid())
  name           String          @unique
  ownerId        String
  owner          User            @relation(fields: [ownerId], references: [id])
  physicalTables PhysicalTable[]
  sessions       GameSession[]
  createdAt      DateTime        @default(now())
}

model BlindStructure {
  id  String  @id @default(uuid())
  name String  @unique

  structure Json  // [{lv:1, sb:100, ante:false, duration:10}, ...]

  storeId String
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model PhysicalTable {
  id        String @id @default(uuid())
  number    Int    // 매장 내 고유 번호

  storeId   String
  store     Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  sessionTables SessionTable[]

  @@unique([storeId, number])
}

model GameSession {
  id             String        @id @default(uuid())
  name           String
  type           SessionType
  status         SessionStatus @default(PENDING)

  blindStructure BlindStructure @relation(fields: [blindId], references: [id])
  blindId        String?

  // 실시간 전광판용 데이터
  activePlayers     Int     @default(0)
  totalEntries      Int     @default(0)
  avgStack          Int
  totalBuyinAmount  Int     @default(0)    // 바이인 누적 총 금액
  isRegistrationOpen Boolean @default(true) // 레지 마감 여부
  
  dealerOtp      Int       // 전 테이블 공통 딜러 인증 코드(짧은 숫자)
  storeId        String
  store          Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)

  sessionTables   SessionTable[]
  participations  SessionParticipation[]
  activeDealers   DealerSession[]
  blindStructures BlindStructure[]

  tournament     Tournament?
  sitAndGo       SitAndGo?

  createdAt      DateTime      @default(now())
  startedAt      DateTime?
  finishedAt     DateTime?
}


model SessionParticipation {
  id           String              @id @default(uuid())
  userId       String
  user         User                @relation(fields: [userId], references: [id])
  sessionId    String
  session      GameSession         @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  buyInPoints  Int                 @default(0) // 지불한 총 포인트 누적
  
  status       ParticipationStatus @default(WAITING)
  
  finalRank    Int?                @default(null) // 최종등수
  prizePoints  Int?                @default(0) // 최종 획득 상금
  
  createdAt    DateTime            @default(now())

  @@unique([userId, sessionId])
}

model DealerSession {
  id              String       @id @default(uuid())
  sessionId       String
  session         GameSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  physicalTableId String       // 딜러가 맡은 물리 테이블 ID
  
  // 딜러 식별용 토큰 (회원가입 대신 발급되는 임시 권한 증표)
  // 세션 접속 시점에 생성되어 딜러의 브라우저/태블릿 LocalStorage에 저장
  authToken       String       @unique @default(uuid())
  
  createdAt       DateTime     @default(now())
  lastActiveAt    DateTime     @updatedAt

  @@unique([sessionId, physicalTableId]) // 한 테이블엔 한 명의 딜러만
}

model SessionTable {
  id              String       @id @default(uuid())
  sessionId       String
  session         GameSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  physicalTableId String
  physicalTable   PhysicalTable @relation(fields: [physicalTableId], references: [id])

  tablePlayers    TablePlayer[]
}

model TablePlayer {
  id              String       @id @default(uuid())
  sessionTableId  String
  sessionTable    SessionTable @relation(fields: [sessionTableId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User         @relation(fields: [userId], references: [id])

  seatPosition    Int          // 1~9 (9인테이블)
  currentStack    Int          // 실시간 칩 스택
  isEliminated    Boolean      @default(false)

  joinedAt        DateTime     @default(now())

  @@unique([sessionTableId, seatPosition])
  @@unique([sessionTableId, userId])
}

model Tournament {
  id                String  @id // GameSession ID 1:1

  maxTables         Int     
  maxPlayers        Int
  
  session GameSession @relation(fields: [id], references: [id], onDelete: Cascade)
}

model SitAndGo {
  id         String  @id // GameSession ID 1:1

  minPlayers Int
  maxPlayers Int

  session GameSession @relation(fields: [id], references: [id], onDelete: Cascade)
}